# 🎰 Boracay Casino 개발 일지 (2026-02-14 Part 2)

## 작업 요약
**백테스트 엔진 구현 완료**

toto_002_basktest_260213.md 스펙에 따라 실전 로직과 100% 동기화된 백테스트 엔진을 구현했다.

---

## 구현 내용

### 1. 백테스트 엔진 (`tests/backtester.py`)

#### A. 핵심 클래스

**`BacktestConfig`** - 전략 설정
```python
INITIAL_BALANCE = 100.0          # 초기 자산
BET_AMOUNT = 5.1                 # 베팅 금액
STOP_LOSS_THRESHOLD = -25.0      # 손절 기준 (실전과 동일)
TS_ACTIVATION_REWARD = 25.0      # 트레일링 활성화 (실전과 동일)
TS_CALLBACK_RATE = 10.0          # 익절 콜백 (실전과 동일)
TRADING_FEE_PERCENT = 0.3        # 거래 비용 (0.15% x 2)
TIMEFRAME = '5m'                 # 5분봉 사용
TEST_CYCLES = [48, 72, 96]       # 테스트할 주기들
```

**`Position`** - 포지션 관리
- 진입가, 진입시간, 베팅금액
- 트레일링 스탑 상태 (`is_ts_active`, `peak_price`)
- `activate_trailing_stop()`: 트레일링 활성화
- `update_peak_price()`: 최고가 갱신
- `get_pnl_percent()`: 현재 수익률 계산

**`Trade`** - 거래 기록
- 진입/청산 가격, 시간
- PNL (%, USDT)
- 거래 비용 반영한 순손익
- 청산 사유 (stop_loss, trailing_stop, timeout)

**`BacktestEngine`** - 시뮬레이션 엔진
- MEXC API로 과거 5분봉 데이터 다운로드
- 포지션 진입/청산 시뮬레이션
- 잔고 추적 (마이너스 허용)
- 파산 지점 기록
- 리포트 생성

#### B. 청산 로직 (실전과 100% 동기화)

```python
def check_exit_conditions(candle):
    # 1. 손절 체크 (Low 기준)
    if pnl_at_low <= -25.0:
        return True, 'stop_loss'
    
    # 2. 트레일링 활성화 (High 기준)
    if not is_ts_active and pnl_at_high >= 25.0:
        activate_trailing_stop(high)
    
    # 3. 트레일링 익절 (Low 기준)
    if is_ts_active:
        update_peak_price(high)
        if low <= peak * 0.9:
            return True, 'trailing_stop'
    
    # 4. 타임아웃
    if elapsed >= cycle_hours:
        return True, 'timeout'
```

**핵심 특징:**
- **High/Low 체크**: 종가만 보는 것이 아니라 캔들 내부 변동 반영
- **손절은 Low 기준**: 가장 불리한 시점 (실전 재현)
- **트레일링 활성화는 High 기준**: 가장 유리한 시점
- **익절도 Low 기준**: 실제로 10% 하락했을 때 체결

#### C. 거래 비용 반영

```python
# 진입 시 0.15%, 청산 시 0.15%, 총 0.3%
net_pnl_usdt = amount_usdt * (pnl_percent / 100) * (1 - 0.003)
```

#### D. 마이너스 잔고 허용

```python
# 잔고 부족해도 시뮬레이션 계속 진행
if balance < BET_AMOUNT:
    pass  # 계속 진행
```

파산 지점은 기록하되 중단하지 않음 → 전체 기간 분석 가능

---

### 2. 실행 스크립트 (`run_backtest.py`)

#### 기능
- CLI 인터페이스
- 다중 주기 자동 비교 (48h, 72h, 96h)
- JSON 결과 저장
- 요약 리포트 출력

#### 사용 예시
```bash
# 기본 실행
python run_backtest.py BTC/USDT 2024-01-01 2024-12-31

# 주기 커스터마이징
python run_backtest.py ETH/USDT 2024-06-01 2024-12-31 --cycles 24,48,72

# 출력 파일 지정
python run_backtest.py BTC/USDT 2024-01-01 2024-12-31 -o results.json
```

---

### 3. 리포트 항목

#### A. 수익성 분석
- 초기/최종/최고 잔고
- 총 손익 (USDT, %)
- 평균 수익률 (전체/승/패)

#### B. 거래 통계
- 총 거래 횟수
- 승/패 횟수 및 승률
- 청산 사유별 분포
  - `stop_loss`: 손절 횟수
  - `trailing_stop`: 익절 횟수
  - `timeout`: 타임아웃 횟수

#### C. 생존 분석
- 생존 일수
- 파산 지점
  - 시점
  - 잔고
  - 거래 횟수

#### D. 최대 잭팟
- 단일 종목 최고 수익률
- 청산 사유
- 시점

#### E. 최종 추천
- 최고 수익 주기
- 최장 생존 주기

---

## 출력 예시

```
================================================================================
📊 백테스트 최종 리포트
================================================================================
Symbol: BTC/USDT
Period: 2024-01-01 ~ 2024-12-31

────────────────────────────────────────────────────────────────────────────────

🎯 주기: 48h
  초기 자산: 100.0 USDT
  최종 잔고: 127.5 USDT (PNL: +27.50 USDT / +27.50%)
  최고 잔고: 145.2 USDT
  거래 횟수: 85 (승: 52, 패: 33)
  승률: 61.2%
  평균 수익률: 5.3% (승: 18.5%, 패: -15.2%)
  생존 일수: 180 일
  청산 사유: {'stop_loss': 28, 'trailing_stop': 35, 'timeout': 22}
  🎉 최대 잭팟: 87.5% (SHIB/USDT, trailing_stop)

🎯 주기: 72h
  ...

🎯 주기: 96h
  ...

────────────────────────────────────────────────────────────────────────────────
🏆 최종 추천
  - 최고 수익 주기: 48h (잔고: 127.5 USDT)
  - 최장 생존 주기: 72h (210 일)
================================================================================
```

---

## 주요 특징

### 1. 실전 로직 100% 동기화
- `core/config.py`의 설정값 그대로 사용
- `scheduler_engine.py`의 로직과 동일한 체크 순서
- 트레일링 스탑 상태 관리 동일

### 2. 데이터 정밀도
- **OHLCV 사용**: Open, High, Low, Close, Volume 모두 활용
- **High/Low 기준 체크**: 종가만 보면 놓치는 손절/익절 반영
- **5분봉**: 실전 감시 주기와 동일

### 3. 비용 현실성
- 진입/청산 각 0.15% 수수료
- 슬리피지 포함 총 0.3% 반영
- 순손익 계산으로 정확한 잔고 추적

### 4. 분석 완결성
- 파산해도 멈추지 않고 전체 기간 분석
- 여러 주기 자동 비교
- JSON 저장으로 추가 분석 가능

---

## 데이터 다운로드

### MEXC API 사용
```python
exchange = ccxt.mexc({'enableRateLimit': True})
candles = exchange.fetch_ohlcv(symbol, '5m', since=timestamp, limit=1000)
```

### 특징
- 공개 API (인증 불필요)
- rateLimit 적용 (자동 대기)
- 1000개 캔들씩 페이징

### 예상 시간
- 1년치 5분봉: ~105,000 캔들
- 다운로드: 1~3분 소요

---

## 파일 구조

```
tests/
├── __init__.py          # 패키지 초기화
├── backtester.py        # 백테스트 엔진 (핵심)
└── README.md            # 백테스트 가이드

run_backtest.py          # CLI 실행 스크립트 (루트)
```

---

## 검증 필요 사항

### 1. 데이터 정확성
- [ ] MEXC API 응답 검증
- [ ] OHLCV 데이터 무결성 체크
- [ ] 타임스탬프 정렬 확인

### 2. 로직 검증
- [ ] 손절 타이밍 (Low 기준)
- [ ] 트레일링 활성화 (High 기준)
- [ ] 익절 타이밍 (Low 기준)
- [ ] 거래 비용 반영 정확성

### 3. 리포트 검증
- [ ] 승률 계산 정확성
- [ ] 파산 지점 기록
- [ ] 최대 잭팟 추출
- [ ] 주기별 비교 로직

### 4. 엣지 케이스
- [ ] 데이터 누락 시 처리
- [ ] 주기가 기간보다 긴 경우
- [ ] 첫 거래부터 손절/익절

---

## 다음 작업

1. **실제 백테스트 실행**
   - BTC/USDT 2024년 전체
   - 여러 알트코인 테스트
   - 48h vs 72h vs 96h 비교

2. **결과 분석**
   - 최적 주기 도출
   - 청산 사유 분포 분석
   - 생존성 vs 수익성 트레이드오프

3. **전략 개선 검토**
   - 손절/익절 임계값 조정 필요성
   - 트레일링 콜백 비율 최적화
   - 주기별 전략 차별화

4. **문서화**
   - 백테스트 결과 정리
   - 전략 선택 가이드
   - DEV_NOTES.md 업데이트

---

## 기술적 고려사항

### 메모리 효율
- 데이터프레임 사용으로 메모리 효율적
- 필요 시 청크 단위 처리 가능

### 성능 최적화
- ccxt rateLimit로 API 제한 준수
- 데이터 캐싱 고려 가능

### 확장성
- 새로운 전략 추가 용이
- 다른 거래소 지원 가능 (ccxt)
- 멀티 심볼 병렬 테스트 가능

---

## 변경된 파일
- `tests/backtester.py` (신규, ~350 lines)
- `tests/__init__.py` (신규)
- `tests/README.md` (신규)
- `run_backtest.py` (신규, ~50 lines)
- `DEV_NOTES.md` (업데이트)
- `docs/planning/toto_002_basktest_260213.md` (다음 작업: 완료 표시 추가)

**Total**: ~400 lines added

---

## 마무리

실전 트레일링 스탑 전략을 검증할 수 있는 백테스트 엔진이 완성되었다.

**핵심 특징:**
1. 실전 로직과 100% 동기화
2. High/Low 기준 정밀 체크
3. 거래 비용 반영
4. 마이너스 잔고 허용 (전체 분석)
5. 다중 주기 자동 비교

다음 작업: 실제 과거 데이터로 백테스트 실행하여 48h/72h/96h 중 최적 주기 검증.

---

**작성일**: 2026-02-14
**작업 시간**: 약 2시간
**난이도**: ⭐⭐⭐⭐ (복잡한 시뮬레이션 로직)
