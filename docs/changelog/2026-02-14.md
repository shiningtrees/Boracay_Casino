# 🎰 Boracay Casino 개발 일지 (2026-02-14)

## 작업 요약
**트레일링 스탑 전략 구현 완료**

toto_001_max_profit_260213.md 스펙에 따라 손절/익절 자동화 로직을 구현했다.

---

## 구현 내용

### 1. 설정 추가 (`core/config.py`)
```python
# 6. 손절/익절 설정
STOP_LOSS_THRESHOLD = -25.0   # 진입가 대비 -25% 도달 시 즉시 손절
TS_ACTIVATION_REWARD = 25.0   # 수익률 +25% 도달 시 트레일링 스탑 활성화
TS_CALLBACK_RATE = 10.0       # 최고점(Peak) 대비 10% 하락 시 익절 매도
CHECK_INTERVAL = 300          # 감시 주기 (5분/300초)
```

### 2. 상태 관리 확장 (`core/state_manager.py`)
- 상태 파일에 `trailing_stop` 필드 추가
  ```python
  "trailing_stop": {
      "is_active": False,
      "peak_price": None
  }
  ```
- 신규 메서드:
  - `get_trailing_stop_state()`: 트레일링 상태 조회
  - `activate_trailing_stop(peak_price)`: 트레일링 활성화
  - `update_peak_price(new_peak)`: 최고가 갱신
- 베팅 시작/종료 시 트레일링 상태 자동 초기화

### 3. 손절/익절 로직 구현 (`core/scheduler_engine.py`)
`check_48h_exit_callback()` 메서드를 확장하여 5분마다 체크:

#### 체크 순서
1. **손절 체크** (최우선)
   - 수익률 ≤ -25% → 즉시 매도, reason="stop_loss"
   - 텔레그램 알림: 🛑 [손절 실행]

2. **트레일링 스탑 로직**
   - **비활성 상태**: 수익률 ≥ +25% 도달 시
     - 트레일링 활성화, 현재가를 peak_price로 기록
     - 텔레그램 알림: 🎯 [트레일링 활성화]
   
   - **활성 상태**:
     - 현재가 > peak_price → peak 갱신 (로그 기록)
     - 현재가 ≤ peak × 0.9 → 즉시 매도, reason="trailing_stop"
     - 텔레그램 알림: 🎉 [익절 실행]

3. **타임아웃 체크** (기존 로직 유지)
   - 48시간 경과 시 자동 청산

### 4. Job 주기 및 알림 업데이트 (`main.py`)
- 감시 Job 주기: 1분 → 5분 (300초)
- 부팅 메시지에 전략 정보 추가:
  ```
  🛑 Stop Loss: -25.0%
  🎯 TS Activation: +25.0%
  📉 TS Callback: 10.0%
  🔍 Check Interval: 300초
  ```

---

## 주요 특징

### 안전성
- 실제 주문 전 재시도 로직 적용 (`_create_market_sell_with_retry`)
- 주문 실패 시 상태 유지 및 텔레그램 알림
- 시세 조회 실패 시 해당 주기 스킵 (다음 5분 후 재시도)

### 로그 추적
- 트레일링 활성화/최고가 갱신/손절/익절 모든 이벤트 로그 기록
- 텔레그램 실시간 알림으로 사용자 모니터링 가능

### 상태 동기화
- `casino_state.json`에 트레일링 상태 저장
- 봇 재시작 시에도 트레일링 상태 유지 (peak_price 보존)

---

## 동작 흐름

```
┌─────────────┐
│ 코인 진입   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────┐
│ 5분마다 체크                │
│                             │
│ ① PNL ≤ -25%?              │
│    └→ YES: 손절 매도        │
│    └→ NO: 다음 체크         │
│                             │
│ ② PNL ≥ +25%?              │
│    └→ YES: 트레일링 활성화   │
│    └→ NO: 타임아웃 체크     │
│                             │
│ ③ 트레일링 활성화 상태?     │
│    ├→ 현재가 > Peak?        │
│    │   └→ Peak 갱신         │
│    └→ 현재가 ≤ Peak×0.9?   │
│        └→ 익절 매도         │
│                             │
│ ④ 48h 경과?                │
│    └→ YES: 타임아웃 매도    │
└─────────────────────────────┘
```

---

## 테스트 필요 사항

1. **손절 시나리오**
   - 코인 진입 후 -25% 하락 시 즉시 매도되는지 확인
   - 텔레그램 알림 수신 확인

2. **트레일링 활성화**
   - +25% 도달 시 트레일링 활성화 알림
   - peak_price 기록 확인 (casino_state.json)

3. **최고가 추적**
   - 활성화 후 가격 상승 시 peak 갱신 로그 확인
   - 여러 번 갱신되는지 확인

4. **익절 실행**
   - Peak 대비 10% 하락 시 매도
   - Exit Price와 PNL 계산 정확성 확인

5. **재시작 안정성**
   - 트레일링 활성화 상태에서 봇 재시작
   - peak_price 유지되는지 확인

---

## 후속 작업

- [ ] 실전 테스트 (MEXC 충전 후)
- [ ] toto_002 백테스트 엔진 구현 (다음 작업)
- [ ] 손절/익절 통계 누적 (history에 reason 활용)
- [ ] 트레일링 중간 상태 텔레그램 조회 (현재 Peak, 익절 임계값 표시)

---

## 변경된 파일
- `core/config.py` (+6 lines)
- `core/state_manager.py` (+44 lines)
- `core/scheduler_engine.py` (+111 lines, refactored)
- `main.py` (+5 lines)
- `toto_001_max_profit_260213.md` (완료 표시)
- `DEV_NOTES.md` (업데이트)

**Total**: ~170 lines added/modified

---

## 마무리
기존 48시간 타임아웃 전략에 리스크 관리(손절)와 수익 극대화(트레일링) 로직이 추가되었다.
5.1 USDT 소액 베팅 특성상 변동성이 큰 잡코인에서 손실을 제한하고 급등 시 수익을 추격할 수 있게 되었다.

다음 작업: toto_002 백테스트 엔진 구현으로 48h/72h/96h 주기별 최적 전략 검증.
